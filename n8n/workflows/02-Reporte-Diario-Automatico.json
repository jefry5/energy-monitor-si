{
    "name": "Reporte-Diario-Automatico",
    "nodes": [
        {
            "parameters": {
                "rule": {
                    "interval": [
                        {
                            "triggerAtHour": 8,
                            "triggerAtMinute": 0
                        }
                    ]
                }
            },
            "type": "n8n-nodes-base.scheduleTrigger",
            "typeVersion": 1.2,
            "position": [
                -600,
                300
            ],
            "id": "schedule-daily-id",
            "name": "Diario 8:00 AM"
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "SELECT\n  area,\n  ROUND(SUM(reading)::numeric, 2) AS total_kwh,\n  ROUND(AVG(reading)::numeric, 2) AS promedio_kwh,\n  ROUND(MAX(reading)::numeric, 2) AS pico_kwh,\n  COUNT(*) AS lecturas,\n  MAX(severity) AS estado_max\nFROM energy_history\nWHERE timestamp >= NOW() - INTERVAL '24 hours'\nGROUP BY area\nORDER BY total_kwh DESC;",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                -380,
                300
            ],
            "id": "daily-report-data-id",
            "name": "Datos 24h",
            "credentials": {
                "postgres": {
                    "id": "new-postgres-cred-id",
                    "name": "Postgres local"
                }
            }
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "SELECT\n  COUNT(*) AS total_anomalias,\n  COUNT(*) FILTER (WHERE severidad = 'Critico') AS criticas,\n  COUNT(*) FILTER (WHERE severidad = 'Advertencia') AS advertencias\nFROM anomalias\nWHERE timestamp >= NOW() - INTERVAL '24 hours';",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.6,
            "position": [
                -380,
                500
            ],
            "id": "daily-anomaly-count-id",
            "name": "Conteo Anomal√≠as 24h",
            "credentials": {
                "postgres": {
                    "id": "new-postgres-cred-id",
                    "name": "Postgres local"
                }
            }
        },
        {
            "parameters": {
                "mode": "combine",
                "combineBy": "combineAll",
                "options": {}
            },
            "type": "n8n-nodes-base.merge",
            "typeVersion": 3.1,
            "position": [
                -160,
                400
            ],
            "id": "merge-daily-data-id",
            "name": "Unir Datos"
        },
        {
            "parameters": {
                "jsCode": "const energyRows = $('Datos 24h').all().map(i => i.json);\nconst anomalyData = $('Conteo Anomal√≠as 24h').first().json;\n\nconst totalKwh = energyRows.reduce((s, r) => s + Number(r.total_kwh || 0), 0);\nconst costoEstimado = (totalKwh * 0.18).toFixed(2);\nconst co2 = (totalKwh * 0.233).toFixed(2);\nconst anomTotal = Number(anomalyData.total_anomalias || 0);\nconst anomCrit = Number(anomalyData.criticas || 0);\nconst anomWarn = Number(anomalyData.advertencias || 0);\n\nconst sevIcon = { Normal: '‚úÖ', Warning: '‚ö†Ô∏è', Critical: 'üö®' };\n\nlet msg = `üìã <b>REPORTE DIARIO AUTOM√ÅTICO</b>\\n`;\nmsg += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n`;\nmsg += `üïí <i>${new Date().toLocaleString('es-ES', {timeZone:'America/Lima'})}</i>\\n`;\nmsg += `üìä Per√≠odo: √öltimas 24 horas\\n\\n`;\n\nmsg += `<b>‚ö° CONSUMO POR √ÅREA</b>\\n`;\nenergyRows.forEach(r => {\n  const icon = sevIcon[r.estado_max] || '‚ö™';\n  msg += `${icon} <b>${r.area}</b>: ${r.total_kwh} kWh (pico: ${r.pico_kwh})\\n`;\n});\n\nmsg += `\\n<b>üè≠ RESUMEN GLOBAL</b>\\n`;\nmsg += `‚ö° Total: <b>${totalKwh.toFixed(2)} kWh</b>\\n`;\nmsg += `üí∞ Costo: <b>S/. ${costoEstimado}</b>\\n`;\nmsg += `üå± CO‚ÇÇ: <b>${co2} kg</b>\\n\\n`;\n\nmsg += `<b>üö® ANOMAL√çAS DETECTADAS</b>\\n`;\nif (anomTotal === 0) {\n  msg += `‚úÖ Sin anomal√≠as en las √∫ltimas 24h\\n`;\n} else {\n  msg += `üî¥ Cr√≠ticas: <b>${anomCrit}</b>\\n`;\n  msg += `üü† Advertencias: <b>${anomWarn}</b>\\n`;\n  msg += `üìä Total: <b>${anomTotal}</b>\\n`;\n}\n\nmsg += `\\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n`;\nmsg += `ü§ñ <i>Reporte generado autom√°ticamente por EnergyCore v2</i>`;\n\n// Prepare data summary for Gemini\nconst dataSummary = energyRows.map(r => `${r.area}: ${r.total_kwh} kWh (avg: ${r.promedio_kwh}, peak: ${r.pico_kwh})`).join(', ');\n\nreturn [{ json: { report_text: msg, data_summary: dataSummary, total_kwh: totalKwh.toFixed(2), anomalias: anomTotal } }];"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                60,
                400
            ],
            "id": "format-daily-report-id",
            "name": "Formatear Reporte Diario"
        },
        {
            "parameters": {
                "method": "POST",
                "url": "=https://api.telegram.org/bot{{ $env.TELEGRAM_TOKEN }}/sendMessage",
                "sendBody": true,
                "bodyParameters": {
                    "parameters": [
                        {
                            "name": "chat_id",
                            "value": "={{ $env.TELEGRAM_CHAT_ID }}"
                        },
                        {
                            "name": "text",
                            "value": "={{ $json.report_text }}"
                        },
                        {
                            "name": "parse_mode",
                            "value": "HTML"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.4,
            "position": [
                280,
                300
            ],
            "id": "send-daily-report-id",
            "name": "Enviar Reporte Diario"
        },
        {
            "parameters": {
                "promptType": "define",
                "text": "=Eres un analista de eficiencia energ√©tica. Analiza este resumen de consumo de las √∫ltimas 24h de un edificio universitario:\n\n{{ $json.data_summary }}\n\nTotal: {{ $json.total_kwh }} kWh\nAnomal√≠as detectadas: {{ $json.anomalias }}\n\nGenera un an√°lisis BREVE (m√°ximo 4 l√≠neas) con:\n1. El √°rea de mayor preocupaci√≥n\n2. Si el consumo global est√° en rango aceptable\n3. Una recomendaci√≥n concreta para hoy\n\nResponde en espa√±ol, directo y profesional.",
                "messages": {
                    "messageValues": [
                        {
                            "message": "Eres un asistente de eficiencia energ√©tica conciso. Responde en espa√±ol, m√°ximo 4 l√≠neas."
                        }
                    ]
                },
                "batching": {}
            },
            "type": "@n8n/n8n-nodes-langchain.chainLlm",
            "typeVersion": 1.9,
            "position": [
                280,
                500
            ],
            "id": "daily-ai-analysis-id",
            "name": "An√°lisis IA Diario"
        },
        {
            "parameters": {
                "options": {}
            },
            "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
            "typeVersion": 1,
            "position": [
                280,
                660
            ],
            "id": "gemini-daily-id",
            "name": "Gemini Diario",
            "credentials": {
                "googlePalmApi": {
                    "id": "KCTdNJeeCP1jXUX5",
                    "name": "Google Gemini(PaLM) Api account"
                }
            }
        },
        {
            "parameters": {
                "method": "POST",
                "url": "=https://api.telegram.org/bot{{ $env.TELEGRAM_TOKEN }}/sendMessage",
                "sendBody": true,
                "bodyParameters": {
                    "parameters": [
                        {
                            "name": "chat_id",
                            "value": "={{ $env.TELEGRAM_CHAT_ID }}"
                        },
                        {
                            "name": "text",
                            "value": "=üß† <b>AN√ÅLISIS IA DEL D√çA</b>\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n{{ $json.text || $json.output }}\n\nü§ñ <i>An√°lisis autom√°tico por Google Gemini</i>"
                        },
                        {
                            "name": "parse_mode",
                            "value": "HTML"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.4,
            "position": [
                500,
                500
            ],
            "id": "send-daily-ai-id",
            "name": "Enviar An√°lisis IA"
        }
    ],
    "connections": {
        "Diario 8:00 AM": {
            "main": [
                [
                    {
                        "node": "Datos 24h",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Conteo Anomal√≠as 24h",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Datos 24h": {
            "main": [
                [
                    {
                        "node": "Unir Datos",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Conteo Anomal√≠as 24h": {
            "main": [
                [
                    {
                        "node": "Unir Datos",
                        "type": "main",
                        "index": 1
                    }
                ]
            ]
        },
        "Unir Datos": {
            "main": [
                [
                    {
                        "node": "Formatear Reporte Diario",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Formatear Reporte Diario": {
            "main": [
                [
                    {
                        "node": "Enviar Reporte Diario",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "An√°lisis IA Diario",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Gemini Diario": {
            "ai_languageModel": [
                [
                    {
                        "node": "An√°lisis IA Diario",
                        "type": "ai_languageModel",
                        "index": 0
                    }
                ]
            ]
        },
        "An√°lisis IA Diario": {
            "main": [
                [
                    {
                        "node": "Enviar An√°lisis IA",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "active": false,
    "settings": {
        "executionOrder": "v1",
        "timezone": "America/Lima"
    },
    "meta": {
        "templateCredsSetupCompleted": true
    },
    "tags": []
}